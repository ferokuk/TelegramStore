from django.db import transaction
from django

from src.exceptions.insufficient_product import InsufficientStockError


@sync_to_async
def reserve_items(items: list[CartItem]):
    with transaction.atomic():
        for item in items:
            product = item.product

            # Проверяем доступное количество
            available = product.quantity - product.reserved
            if available < item.quantity:
                raise InsufficientStockError(product)

            # Резервируем товар
            product.reserved += item.quantity
            product.save(update_fields=['reserved'])
